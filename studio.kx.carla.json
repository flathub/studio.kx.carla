{
    "app-id": "studio.kx.carla",
    "runtime": "org.kde.Platform",
    "runtime-version": "5.15-22.08",
    "sdk": "org.kde.Sdk",
    "command": "carla",
    "rename-desktop-file": "carla.desktop",
    "rename-icon": "carla",
    "finish-args": [
        "--share=ipc",
        "--socket=x11",
        "--socket=wayland",
        "--socket=pulseaudio",
        "--device=all",
        "--filesystem=xdg-run/pipewire-0",
        "--filesystem=home",
        "--env=TMPDIR=/var/tmp",
        "--env=ALSA_CONFIG_PATH="
    ],
    "add-extensions": {
        "org.freedesktop.LinuxAudio.Plugins": {
            "directory": "extensions/Plugins",
            "version": "22.08",
            "add-ld-path": "lib",
            "merge-dirs": "ladspa;dssi;lv2;vst;vst3",
            "subdirectories": true,
            "no-autodownload": true
        }
    },
    "cleanup": [
        "/include",
        "/man",
        "/share/man",
        "/share/info",
        "/lib/pkgconfig",
        "*.la"
    ],
    "build-options": {
        "env": {
            "PYTHON": "/usr/bin/python3",
            "PIP": "/usr/bin/pip3",
            "PIP_DISABLE_PIP_VERSION_CHECK": "1"
        }
    },
    "modules": [
        "shared-modules/linux-audio/fluidsynth2.json",
        {
            "name": "pyqt",
            "buildsystem": "simple",
            "build-commands": [
                "sh build"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://files.pythonhosted.org/packages/5c/46/b4b6eae1e24d9432905ef1d4e7c28b6610e28252527cdc38f2a75997d8b5/PyQt5-5.15.9.tar.gz",
                    "sha256": "dc41e8401a90dc3e2b692b411bd5492ab559ae27a27424eed4bd3915564ec4c0",
                    "x-checker-data": {
                        "type": "pypi",
                        "name": "pyqt5"
                    }
                },
                {
                    "type": "file",
                    "path": "pyqt-build",
                    "dest-filename": "build"
                },
                {
                    "type": "shell",
                    "commands": [
                        "echo '[tool.sip.bindings.QtGui]' >> pyproject.toml",
                        "echo 'disabled-features = [\"PyQt_Desktop_OpenGL\"]' >> pyproject.toml"
                    ],
                    "only-arches": [
                        "aarch64"
                    ]
                }
            ],
            "cleanup": [
                "/bin"
            ],
            "modules": [
                {
                    "name": "flit_core",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/c4/e6/c1ac50fe3eebb38a155155711e6e864e254ce4b6e17fe2429b4c4d5b9e80/flit_core-3.9.0.tar.gz",
                            "sha256": "72ad266176c4a3fcfab5f2930d76896059851240570ce9a98733b658cb786eba",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "flit_core"
                            }
                        }
                    ]
                },
                {
                    "name": "python-pyparsing",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/71/22/207523d16464c40a0310d2d4d8926daffa00ac1f5b1576170a32db749636/pyparsing-3.0.9.tar.gz",
                            "sha256": "2b020ecf7d21b687f219b71ecad3631f644a47f01403fa1d1036b0c6416d70fb",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "pyparsing"
                            }
                        }
                    ]
                },
                {
                    "name": "python-packaging",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/b9/6c/7c6658d258d7971c5eb0d9b69fa9265879ec9a9158031206d47800ae2213/packaging-23.1.tar.gz",
                            "sha256": "a392980d2b6cffa644431898be54b0045151319d1e7ec34f0cfed48767dd334f",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "packaging"
                            }
                        }
                    ]
                },
                {
                    "name": "python-toml",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/be/ba/1f744cdc819428fc6b5084ec34d9b30660f6f9daaf70eead706e3203ec3c/toml-0.10.2.tar.gz",
                            "sha256": "b3bda1d108d5dd99f4a20d24d9c348e91c4db7ab1b749200bded2f839ccbe68f",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "toml"
                            }
                        }
                    ]
                },
                {
                    "name": "ply",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/e5/69/882ee5c9d017149285cab114ebeab373308ef0f874fcdac9beb90e0ac4da/ply-3.11.tar.gz",
                            "sha256": "00c7c1aaa88358b9c765b6d3000c6eec0ba42abca5351b095321aef446081da3",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "ply"
                            }
                        }
                    ]
                },
                {
                    "name": "sip",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/48/75/98987181e897ef378d6c239ee733328a7264a41f2d8263e61d7b7c4c0909/sip-6.7.9.tar.gz",
                            "sha256": "35d51fc10f599d3696abb50f29d068ad04763df7b77808c76b74597660f99b17",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "sip"
                            }
                        }
                    ]
                },
                {
                    "name": "pyqt-sip",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/c1/61/4055e7a0f36339964956ff415e36f4abf82561904cc49c021da32949fc55/PyQt5_sip-12.12.1.tar.gz",
                            "sha256": "8fdc6e0148abd12d977a1d3828e7b79aae958e83c6cb5adae614916d888a6b10",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "pyqt5-sip"
                            }
                        }
                    ]
                },
                {
                    "name": "pyqt-builder",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/31/d7/dbcb710a205014ca8f1c651ed77e6f1b1d0c67ab43c664afb079d6efb658/PyQt-builder-1.15.1.tar.gz",
                            "sha256": "a2bd3cfbf952e959141dfe55b44b451aa945ca8916d1b773850bb2f9c0fa2985",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "pyqt-builder"
                            }
                        }
                    ]
                }
            ]
        },
        {
            "name": "carla",
            "buildsystem": "simple",
            "build-commands": [
                "make features",
                "make PREFIX=/app -j $FLATPAK_BUILDER_N_JOBS",
                "make PREFIX=/app install"
            ],
            "build-options": {
                "arch": {
                    "aarch64": {
                        "env": {
                            "NOOPT": "true"
                        }
                    }
                }
            },
            "post-install": [
                "sed -i 's/<release /<release date=\"2023-03-11\" /g' ${FLATPAK_DEST}/share/appdata/studio.kx.carla.appdata.xml",
                "mv ${FLATPAK_DEST}/bin/carla ${FLATPAK_DEST}/bin/carla.bin",
                "install -Dm755 carla-wrap.sh ${FLATPAK_DEST}/bin/carla",
                "install -d /app/extensions/Plugins"
            ],
            "cleanup": [
                "/lib/vst/carla.vst/",
                "/lib/lv2/carla.lv2/"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/falkTX/Carla.git",
                    "tag": "v2.5.5",
                    "commit": "c1c658c00eefad4a5e559ef60f4f185c9e2a50e4",
                    "x-checker-data": {
                        "type": "git",
                        "tag-pattern": "^v([\\d.]+)$"
                    }
                },
                {
                    "type": "file",
                    "path": "carla-wrap.sh"
                }
            ]
        }
    ]
}
