{
    "app-id": "studio.kx.carla",
    "runtime": "org.kde.Platform",
    "runtime-version": "5.15-22.08",
    "sdk": "org.kde.Sdk",
    "command": "carla",
    "rename-desktop-file": "carla.desktop",
    "rename-icon": "carla",
    "finish-args": [
        "--share=ipc",
        "--socket=x11",
        "--socket=wayland",
        "--socket=pulseaudio",
        "--device=all",
        "--filesystem=xdg-run/pipewire-0",
        "--filesystem=home",
        "--env=TMPDIR=/var/tmp",
        "--env=ALSA_CONFIG_PATH="
    ],
    "add-extensions": {
        "org.freedesktop.LinuxAudio.Plugins": {
            "directory": "extensions/Plugins",
            "version": "22.08",
            "add-ld-path": "lib",
            "merge-dirs": "ladspa;dssi;lv2;vst;vst3",
            "subdirectories": true,
            "no-autodownload": true
        }
    },
    "cleanup": [
        "/include",
        "/man",
        "/share/man",
        "/share/info",
        "/lib/pkgconfig",
        "*.la"
    ],
    "build-options": {
        "env": {
            "PYTHON": "/usr/bin/python3",
            "PIP": "/usr/bin/pip3",
            "PIP_DISABLE_PIP_VERSION_CHECK": "1"
        }
    },
    "modules": [
        "shared-modules/linux-audio/fluidsynth2.json",
        {
            "name": "pyqt",
            "buildsystem": "simple",
            "build-commands": [
                "sh build"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://files.pythonhosted.org/packages/e1/57/2023316578646e1adab903caab714708422f83a57f97eb34a5d13510f4e1/PyQt5-5.15.7.tar.gz",
                    "sha256": "755121a52b3a08cb07275c10ebb96576d36e320e572591db16cfdbc558101594",
                    "x-checker-data": {
                        "type": "pypi",
                        "name": "pyqt5"
                    }
                },
                {
                    "type": "file",
                    "path": "pyqt-build",
                    "dest-filename": "build"
                },
                {
                    "type": "shell",
                    "commands": [
                        "echo '[tool.sip.bindings.QtGui]' >> pyproject.toml",
                        "echo 'disabled-features = [\"PyQt_Desktop_OpenGL\"]' >> pyproject.toml"
                    ],
                    "only-arches": [
                        "aarch64"
                    ]
                }
            ],
            "cleanup": [
                "/bin"
            ],
            "modules": [
                {
                    "name": "flit_core",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/15/d1/d8798b83e953fd6f86ca9b50f93eec464a9305b0661469c8234e61095481/flit_core-3.7.1.tar.gz",
                            "sha256": "14955af340c43035dbfa96b5ee47407e377ee337f69e70f73064940d27d0a44f",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "flit_core"
                            }
                        }
                    ]
                },
                {
                    "name": "python-pyparsing",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/71/22/207523d16464c40a0310d2d4d8926daffa00ac1f5b1576170a32db749636/pyparsing-3.0.9.tar.gz",
                            "sha256": "2b020ecf7d21b687f219b71ecad3631f644a47f01403fa1d1036b0c6416d70fb",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "pyparsing"
                            }
                        }
                    ]
                },
                {
                    "name": "python-packaging",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/df/9e/d1a7217f69310c1db8fdf8ab396229f55a699ce34a203691794c5d1cad0c/packaging-21.3.tar.gz",
                            "sha256": "dd47c42927d89ab911e606518907cc2d3a1f38bbd026385970643f9c5b8ecfeb",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "packaging"
                            }
                        }
                    ]
                },
                {
                    "name": "python-toml",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/be/ba/1f744cdc819428fc6b5084ec34d9b30660f6f9daaf70eead706e3203ec3c/toml-0.10.2.tar.gz",
                            "sha256": "b3bda1d108d5dd99f4a20d24d9c348e91c4db7ab1b749200bded2f839ccbe68f",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "toml"
                            }
                        }
                    ]
                },
                {
                    "name": "ply",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/e5/69/882ee5c9d017149285cab114ebeab373308ef0f874fcdac9beb90e0ac4da/ply-3.11.tar.gz",
                            "sha256": "00c7c1aaa88358b9c765b6d3000c6eec0ba42abca5351b095321aef446081da3",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "ply"
                            }
                        }
                    ]
                },
                {
                    "name": "sip",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/5b/cb/c27c925ae07bd03a2597fa1db17bfc2a4ac57da61aeb90f8ec98ffbb975b/sip-6.6.2.tar.gz",
                            "sha256": "0e3efac1c5dfd8e525ae57140927df26993e13f58b89d1577c314f4105bfd90d",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "sip"
                            }
                        }
                    ]
                },
                {
                    "name": "pyqt-sip",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/39/5f/fd9384fdcb9cd0388088899c110838007f49f5da1dd1ef6749bfb728a5da/PyQt5_sip-12.11.0.tar.gz",
                            "sha256": "b4710fd85b57edef716cc55fae45bfd5bfac6fc7ba91036f1dcc3f331ca0eb39",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "pyqt5-sip"
                            }
                        }
                    ]
                },
                {
                    "name": "pyqt-builder",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/31/36/6c73f2bd8e4ac5594f6331735951d16d0800f297473db77996966d57cfc7/PyQt-builder-1.13.0.tar.gz",
                            "sha256": "4877580c38ceb5320e129b381d083b0a8601c68166d8b99707f08fa0a1689eef",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "pyqt-builder"
                            }
                        }
                    ]
                }
            ]
        },
        {
            "name": "carla",
            "buildsystem": "simple",
            "build-commands": [
                "make features",
                "make PREFIX=/app -j $FLATPAK_BUILDER_N_JOBS",
                "make PREFIX=/app install"
            ],
            "build-options": {
                "arch": {
                    "aarch64": {
                        "env": {
                            "NOOPT": "true"
                        }
                    }
                }
            },
            "post-install": [
                "sed -i 's/<release /<release date=\"2022-07-16\" /g' ${FLATPAK_DEST}/share/appdata/studio.kx.carla.appdata.xml",
                "mv ${FLATPAK_DEST}/bin/carla ${FLATPAK_DEST}/bin/carla.bin",
                "install -Dm755 carla-wrap.sh ${FLATPAK_DEST}/bin/carla",
                "install -d /app/extensions/Plugins"
            ],
            "cleanup": [
                "/lib/vst/carla.vst/",
                "/lib/lv2/carla.lv2/"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/falkTX/Carla.git",
                    "tag": "v2.5.0",
                    "commit": "6bc9a90ebb1767649d2538108ed4a604ce96dacb",
                    "x-checker-data": {
                        "type": "git",
                        "tag-pattern": "^v([\\d.]+)$"
                    }
                },
                {
                    "type": "file",
                    "path": "carla-wrap.sh"
                }
            ]
        }
    ]
}
