{
    "app-id": "studio.kx.carla",
    "runtime": "org.kde.Platform",
    "runtime-version": "5.15-21.08",
    "sdk": "org.kde.Sdk",
    "command": "carla",
    "rename-desktop-file": "carla.desktop",
    "rename-icon": "carla",
    "finish-args": [
        "--share=ipc",
        "--socket=x11",
        "--socket=wayland",
        "--socket=pulseaudio",
        "--device=all",
        "--filesystem=xdg-run/pipewire-0",
        "--filesystem=home",
        "--env=TMPDIR=/var/tmp",
        "--env=ALSA_CONFIG_PATH="
    ],
    "add-extensions": {
        "org.freedesktop.LinuxAudio.Plugins": {
            "directory": "extensions/Plugins",
            "version": "21.08",
            "add-ld-path": "lib",
            "merge-dirs": "ladspa;dssi;lv2;lxvst;vst3",
            "subdirectories": true,
            "no-autodownload": true
        }
    },
    "cleanup": [
        "/include",
        "/man",
        "/share/man",
        "/share/info",
        "/lib/pkgconfig",
        "*.la"
    ],
    "build-options": {
        "env": {
            "PYTHON": "/usr/bin/python3",
            "PIP": "/usr/bin/pip3",
            "PIP_DISABLE_PIP_VERSION_CHECK": "1"
        }
    },
    "modules": [
        "shared-modules/linux-audio/fluidsynth2.json",
        {
            "name": "pyqt",
            "buildsystem": "simple",
            "build-commands": [
                "sh build"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://files.pythonhosted.org/packages/3b/27/fd81188a35f37be9b3b4c2db1654d9439d1418823916fe702ac3658c9c41/PyQt5-5.15.6.tar.gz",
                    "sha256": "80343bcab95ffba619f2ed2467fd828ffeb0a251ad7225be5fc06dcc333af452",
                    "x-checker-data": {
                        "type": "pypi",
                        "name": "pyqt5"
                    }
                },
                {
                    "type": "file",
                    "path": "pyqt-build",
                    "dest-filename": "build"
                },
                {
                    "type": "shell",
                    "commands": [
                        "echo '[tool.sip.bindings.QtGui]' >> pyproject.toml",
                        "echo 'disabled-features = [\"PyQt_Desktop_OpenGL\"]' >> pyproject.toml"
                    ],
                    "only-arches": [
                        "aarch64"
                    ]
                }
            ],
            "cleanup": [
                "/bin"
            ],
            "modules": [
                {
                    "name": "flit_core",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/15/d1/d8798b83e953fd6f86ca9b50f93eec464a9305b0661469c8234e61095481/flit_core-3.7.1.tar.gz",
                            "sha256": "14955af340c43035dbfa96b5ee47407e377ee337f69e70f73064940d27d0a44f",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "flit_core"
                            }
                        }
                    ]
                },
                {
                    "name": "python-pyparsing",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/71/22/207523d16464c40a0310d2d4d8926daffa00ac1f5b1576170a32db749636/pyparsing-3.0.9.tar.gz",
                            "sha256": "2b020ecf7d21b687f219b71ecad3631f644a47f01403fa1d1036b0c6416d70fb",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "pyparsing"
                            }
                        }
                    ]
                },
                {
                    "name": "python-packaging",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/df/9e/d1a7217f69310c1db8fdf8ab396229f55a699ce34a203691794c5d1cad0c/packaging-21.3.tar.gz",
                            "sha256": "dd47c42927d89ab911e606518907cc2d3a1f38bbd026385970643f9c5b8ecfeb",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "packaging"
                            }
                        }
                    ]
                },
                {
                    "name": "python-toml",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/be/ba/1f744cdc819428fc6b5084ec34d9b30660f6f9daaf70eead706e3203ec3c/toml-0.10.2.tar.gz",
                            "sha256": "b3bda1d108d5dd99f4a20d24d9c348e91c4db7ab1b749200bded2f839ccbe68f",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "toml"
                            }
                        }
                    ]
                },
                {
                    "name": "ply",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/e5/69/882ee5c9d017149285cab114ebeab373308ef0f874fcdac9beb90e0ac4da/ply-3.11.tar.gz",
                            "sha256": "00c7c1aaa88358b9c765b6d3000c6eec0ba42abca5351b095321aef446081da3",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "ply"
                            }
                        }
                    ]
                },
                {
                    "name": "sip",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/c6/08/34642c4db19e9d41f43640547c5a997cb9b12b512f8c61d0d476e8b9e883/sip-6.6.1.tar.gz",
                            "sha256": "696c575c72144122701171f2cc767fe6cc87050ea755a04909152a8508ae10c3",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "sip"
                            }
                        }
                    ]
                },
                {
                    "name": "pyqt-sip",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/a3/82/08a09deda701feb930aa6462f2f22e07cbcb9aa7c1ef361a090221b4587e/PyQt5_sip-12.10.1.tar.gz",
                            "sha256": "97e008795c453488f51a5c97dbff29cda7841afb1ca842c9e819d8e6cc0ae724",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "pyqt5-sip"
                            }
                        }
                    ]
                },
                {
                    "name": "pyqt-builder",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/8b/5f/1bd49787262ddce37b826ef49dcccf5a9970facf0ed363dee5ee233e681d/PyQt-builder-1.12.2.tar.gz",
                            "sha256": "f62bb688d70e0afd88c413a8d994bda824e6cebd12b612902d1945c5a67edcd7",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "pyqt-builder"
                            }
                        }
                    ]
                }
            ]
        },
        {
            "name": "carla",
            "buildsystem": "simple",
            "build-commands": [
                "make features",
                "make PREFIX=/app -j $FLATPAK_BUILDER_N_JOBS",
                "make PREFIX=/app install"
            ],
            "build-options": {
                "arch": {
                    "aarch64": {
                        "env": {
                            "NOOPT": "true"
                        }
                    }
                }
            },
            "post-install": [
                "sed -i 's/<release /<release date=\"2022-04-15\" /g' ${FLATPAK_DEST}/share/appdata/studio.kx.carla.appdata.xml",
                "mv ${FLATPAK_DEST}/bin/carla ${FLATPAK_DEST}/bin/carla.bin",
                "install -Dm755 carla-wrap.sh ${FLATPAK_DEST}/bin/carla",
                "install -d /app/extensions/Plugins"
            ],
            "cleanup": [
                "/lib/vst/carla.vst/",
                "/lib/lv2/carla.lv2/"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/falkTX/Carla.git",
                    "tag": "v2.4.3",
                    "commit": "f22915f6ec0093a0d27c4b3e3cf27724d5bc536b",
                    "x-checker-data": {
                        "type": "git",
                        "tag-pattern": "^v([\\d.]+)$"
                    }
                },
                {
                    "type": "file",
                    "path": "carla-wrap.sh"
                }
            ]
        }
    ]
}
